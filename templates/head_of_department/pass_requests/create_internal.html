{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Создать заявку через внутренние посты ВЧНГ</h2>
        <a href="{{ url_for('pass_requests_list') }}" class="btn btn-secondary">Назад к списку</a>
    </div>

    <form method="POST" action="{{ url_for('save_pass_request') }}" id="passRequestForm">
        <input type="hidden" name="request_type" value="{{ request_type }}">

        <div class="row">
            <!-- Левая колонка -->
            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-header">
                        <h5>Основные данные</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Посты *</label>
                            <div id="postsListContainer"
                                style="border: 1px solid #ced4da; border-radius: 0.375rem; padding: 1rem; background: #f8f9fa;">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <small class="text-muted">Выберите один или несколько постов</small>
                                    <button type="button" class="btn btn-sm btn-outline-secondary"
                                        onclick="toggleAll('posts')">
                                        Выбрать все
                                    </button>
                                </div>
                                <div class="input-group mb-2">
                                    <input type="text" class="form-control" placeholder="Поиск постов..."
                                        id="postsSearch" onkeyup="filterItems('posts')">
                                    <span class="input-group-text">
                                        <i class="bi bi-search"></i>
                                    </span>
                                </div>
                                <div
                                    style="border: 1px solid #ced4da; border-radius: 0.375rem; background: white; max-height: 250px; overflow-y: auto; padding: 0.5rem;">
                                    {% for post in posts %}
                                    <div
                                        style="display: flex; align-items: flex-start; padding: 8px 10px; border-bottom: 1px solid #f8f9fa; width: 100%; box-sizing: border-box;">
                                        <input type="checkbox" name="posts" value="{{ post.id }}"
                                            id="post_{{ post.id }}"
                                            style="margin-right: 10px; margin-top: 3px; flex-shrink: 0;">
                                        <label for="post_{{ post.id }}"
                                            style="flex: 1; margin: 0; cursor: pointer; min-width: 0; word-wrap: break-word; white-space: normal;">
                                            <div style="font-weight: 600; word-break: break-word;">{{ post.name }}</div>
                                            {% if post.description %}
                                            <div
                                                style="font-size: 0.875em; color: #6c757d; word-break: break-word; margin-top: 2px;">
                                                {{ post.description }}</div>
                                            {% endif %}
                                        </label>
                                    </div>
                                    {% endfor %}
                                </div>
                                <small class="text-muted mt-2 d-block" id="postsCount">Выбрано: 0 постов</small>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Номер договора *</label>
                            <select class="form-select" name="contract_id" id="contractSelect" required>
                                <option value="">Выберите договор</option>
                                {% for contract in contracts %}
                                <option value="{{ contract.id }}">{{ contract.number }} от {{
                                    contract.start_date.strftime('%d.%m.%Y') }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">ИНН *</label>
                            <div class="input-group">
                                <select class="form-select" name="inn_id" required>
                                    <option value="">Выберите ИНН организации</option>
                                    {% for inn in inns %}
                                    <option value="{{ inn.id }}">
                                        {{ inn.inn }} - {{ inn.organization_name }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="btn btn-outline-primary"
                                    onclick="window.open('{{ url_for('manage_dictionaries') }}', '_blank')">
                                    Управление
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-header">
                        <h5>Период действия</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Дата начала *</label>
                                <input type="date" class="form-control" name="start_date" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Дата окончания *</label>
                                <input type="date" class="form-control" name="end_date" required>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Правая колонка -->
            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-header">
                        <h5>Сотрудники</h5>
                    </div>
                    <div class="card-body">
                        <div id="employeesListContainer"
                            style="border: 1px solid #ced4da; border-radius: 0.375rem; padding: 1rem; background: #f8f9fa;">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <small class="text-muted">Выберите сотрудников</small>
                                <button type="button" class="btn btn-sm btn-outline-secondary"
                                    onclick="toggleAll('employees')">
                                    Выбрать всех
                                </button>
                            </div>
                            <div class="input-group mb-2">
                                <input type="text" class="form-control" placeholder="Поиск по фамилии..."
                                    id="employeesSearch" onkeyup="filterItems('employees')">
                                <span class="input-group-text">
                                    <i class="bi bi-search"></i>
                                </span>
                            </div>
                            <div
                                style="border: 1px solid #ced4da; border-radius: 0.375rem; background: white; max-height: 250px; overflow-y: auto; padding: 0.5rem;">
                                {% for employee in employees %}
                                <div
                                    style="display: flex; align-items: flex-start; padding: 8px 10px; border-bottom: 1px solid #f8f9fa; width: 100%; box-sizing: border-box;">
                                    <input type="checkbox" name="employees" value="{{ employee.id }}"
                                        id="employee_{{ employee.id }}"
                                        style="margin-right: 10px; margin-top: 3px; flex-shrink: 0;">
                                    <label for="employee_{{ employee.id }}"
                                        style="flex: 1; margin: 0; cursor: pointer; min-width: 0; word-wrap: break-word; white-space: normal;">
                                        <div style="font-weight: 600; word-break: break-word;">
                                            {{ employee.last_name }} {{ employee.first_name }} {{ employee.middle_name
                                            or '' }}
                                        </div>
                                        <div
                                            style="font-size: 0.875em; color: #6c757d; word-break: break-word; margin-top: 2px;">
                                            {{ employee.position.name if employee.position else '' }}
                                            {% if employee.pass_number %} | Допуск: {{ employee.pass_number }}{% endif
                                            %}
                                        </div>
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                            <small class="text-muted mt-2 d-block" id="employeesCount">Выбрано: 0 сотрудников</small>
                        </div>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-header">
                        <h5>Транспорт</h5>
                    </div>
                    <div class="card-body">
                        <div id="vehiclesListContainer"
                            style="border: 1px solid #ced4da; border-radius: 0.375rem; padding: 1rem; background: #f8f9fa;">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <small class="text-muted">Выберите транспорт</small>
                                <button type="button" class="btn btn-sm btn-outline-secondary"
                                    onclick="toggleAll('vehicles')">
                                    Выбрать все
                                </button>
                            </div>
                            <div class="input-group mb-2">
                                <input type="text" class="form-control" placeholder="Поиск по госномеру или марке..."
                                    id="vehiclesSearch" onkeyup="filterItems('vehicles')">
                                <span class="input-group-text">
                                    <i class="bi bi-search"></i>
                                </span>
                            </div>
                            <div
                                style="border: 1px solid #ced4da; border-radius: 0.375rem; background: white; max-height: 250px; overflow-y: auto; padding: 0.5rem;">
                                {% for vehicle in vehicles %}
                                <div
                                    style="display: flex; align-items: flex-start; padding: 8px 10px; border-bottom: 1px solid #f8f9fa; width: 100%; box-sizing: border-box;">
                                    <input type="checkbox" name="vehicles" value="{{ vehicle.id }}"
                                        id="vehicle_{{ vehicle.id }}"
                                        style="margin-right: 10px; margin-top: 3px; flex-shrink: 0;">
                                    <label for="vehicle_{{ vehicle.id }}"
                                        style="flex: 1; margin: 0; cursor: pointer; min-width: 0; word-wrap: break-word; white-space: normal;">
                                        <div style="font-weight: 600; word-break: break-word;">
                                            {{ vehicle.brand }} ({{ vehicle.license_plate }})
                                        </div>
                                        <div
                                            style="font-size: 0.875em; color: #6c757d; word-break: break-word; margin-top: 2px;">
                                            {{ vehicle.vehicle_type.name if vehicle.vehicle_type else '' }}
                                            {% if vehicle.pass_number %} | Допуск: {{ vehicle.pass_number }}{% endif %}
                                        </div>
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                            <small class="text-muted mt-2 d-block" id="vehiclesCount">Выбрано: 0 транспортных
                                средств</small>
                        </div>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-header">
                        <h5>Согласование</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Согласующий *</label>
                            <select class="form-select" name="agreement_person_id" required>
                                <option value="">Выберите согласующего</option>
                                {% for person in agreement_persons %}
                                <option value="{{ person.id }}">
                                    {{ person.position }} - {{ person.full_name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Заявку сформировал *</label>
                            <input type="text" class="form-control" name="formed_by" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Цель заезда</label>
                            <textarea class="form-control" name="purpose" rows="3"></textarea>
                        </div>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-header">
                        <h5>Шаблон документа</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <input type="file" class="form-control" name="template" accept=".docx">
                            <small class="text-muted">Выберите файл шаблона Word</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-12">
                <button type="submit" class="btn btn-success">Сохранить и сгенерировать</button>
                <a href="{{ url_for('pass_requests_list') }}" class="btn btn-secondary">Отменить</a>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block styles %}
<style>
    /* ОСНОВНЫЕ ИСПРАВЛЕНИЯ ДЛЯ ШИРИНЫ */
    .multiselect-card {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 1rem;
        background-color: #f8f9fa;
        width: 100% !important;
        /* Добавляем */
        min-width: 100% !important;
        /* Добавляем */
    }

    .multiselect-list {
        background-color: white;
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
        padding: 0.5rem;
        max-height: 300px !important;
        overflow-y: auto;
        width: 100% !important;
        /* Добавляем */
        min-width: 100% !important;
        /* Добавляем */
    }

    /* КРИТИЧЕСКИ ВАЖНО - растягиваем элементы на всю ширину */
    .multiselect-item {
        padding: 0.5rem;
        border-bottom: 1px solid #f8f9fa;
        transition: background-color 0.2s;
        width: 100% !important;
        /* Добавляем */
        min-width: 100% !important;
        /* Добавляем */
        display: block !important;
        /* Добавляем */
        margin-left: 0 !important;
        /* Добавляем */
        margin-right: 0 !important;
        /* Добавляем */
    }

    .multiselect-item:last-child {
        border-bottom: none;
    }

    .multiselect-item:hover {
        background-color: #e9ecef;
        border-radius: 0.25rem;
    }

    /* Растягиваем label на всю ширину */
    .multiselect-item .form-check-label {
        cursor: pointer;
        width: 100% !important;
        /* Меняем на 100% */
        min-width: 100% !important;
        /* Добавляем */
        display: block !important;
        /* Добавляем */
        word-wrap: break-word;
        /* Добавляем перенос слов */
        white-space: normal;
        /* Добавляем нормальные переносы */
    }

    /* Улучшаем отображение текста */
    .multiselect-item .form-check-label strong {
        display: block;
        word-break: break-word;
        /* Перенос длинных слов */
    }

    .multiselect-item .form-check-label small {
        display: block;
        word-break: break-word;
        /* Перенос длинных слов */
        line-height: 1.3;
    }

    .hidden-item {
        display: none;
    }

    .selected-count {
        font-weight: 600;
        color: #0d6efd;
    }

    /* Улучшаем скроллинг */
    .multiselect-list::-webkit-scrollbar {
        width: 8px;
    }

    .multiselect-list::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }

    .multiselect-list::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
    }

    .multiselect-list::-webkit-scrollbar-thumb:hover {
        background: #555;
    }

    /* Гарантируем что карточки занимают всю ширину колонки */
    .card-body {
        width: 100% !important;
    }

    /* Убираем возможные ограничения у колонок */
    .col-md-6 {
        min-width: 0;
        /* Важно для flex контекста */
    }

    /* Улучшаем отступы */
    .multiselect-item {
        padding: 0.75rem 0.5rem !important;
        /* Увеличиваем вертикальные отступы */
        margin-bottom: 0.1rem !important;
    }

    .multiselect-item .form-check-label {
        font-size: 0.9rem;
        line-height: 1.4;
        /* Улучшаем межстрочный интервал */
    }

    /* Скрываем лишние описания на маленьких экранах */
    @media (max-width: 768px) {
        .multiselect-item .text-muted {
            display: none;
        }
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    // Инициализация при загрузке страницы
    document.addEventListener('DOMContentLoaded', function () {
        updateSelectionCounts();

        // Добавляем обработчики изменения состояния чекбоксов
        document.querySelectorAll('input[type="checkbox"][name="posts"]').forEach(checkbox => {
            checkbox.addEventListener('change', updateSelectionCounts);
        });

        document.querySelectorAll('input[type="checkbox"][name="employees"]').forEach(checkbox => {
            checkbox.addEventListener('change', updateSelectionCounts);
        });

        document.querySelectorAll('input[type="checkbox"][name="vehicles"]').forEach(checkbox => {
            checkbox.addEventListener('change', updateSelectionCounts);
        });
    });

    // Функция для переключения всех элементов в группе
    function toggleAll(type) {
        const checkboxes = document.querySelectorAll(`input[type="checkbox"][name="${type}"]:not(.hidden-item)`);
        const allChecked = Array.from(checkboxes).every(checkbox => checkbox.checked);

        checkboxes.forEach(checkbox => {
            checkbox.checked = !allChecked;
        });

        updateSelectionCounts();
    }

    // Функция для фильтрации элементов
    function filterItems(type) {
        const searchTerm = document.getElementById(`${type}Search`).value.toLowerCase();
        const items = document.querySelectorAll(`#${type}List .multiselect-item`);

        items.forEach(item => {
            const label = item.querySelector('.form-check-label').textContent.toLowerCase();
            if (label.includes(searchTerm)) {
                item.classList.remove('hidden-item');
            } else {
                item.classList.add('hidden-item');
            }
        });
    }

    // Функция для обновления счетчиков выбранных элементов
    function updateSelectionCounts() {
        // Посты
        const selectedPosts = document.querySelectorAll('input[name="posts"]:checked').length;
        document.getElementById('postsCount').innerHTML = `Выбрано: <span class="selected-count">${selectedPosts}</span> постов`;

        // Сотрудники
        const selectedEmployees = document.querySelectorAll('input[name="employees"]:checked').length;
        document.getElementById('employeesCount').innerHTML = `Выбрано: <span class="selected-count">${selectedEmployees}</span> сотрудников`;

        // Транспорт
        const selectedVehicles = document.querySelectorAll('input[name="vehicles"]:checked').length;
        document.getElementById('vehiclesCount').innerHTML = `Выбрано: <span class="selected-count">${selectedVehicles}</span> транспортных средств`;
    }

    // Валидация формы
    document.getElementById('passRequestForm').addEventListener('submit', function (e) {
        const startDate = new Date(document.querySelector('input[name="start_date"]').value);
        const endDate = new Date(document.querySelector('input[name="end_date"]').value);

        if (startDate > endDate) {
            e.preventDefault();
            alert('Дата окончания не может быть раньше даты начала');
            return;
        }

        // Проверяем что выбран хотя бы один пост
        const selectedPosts = document.querySelectorAll('input[name="posts"]:checked').length;
        if (selectedPosts === 0) {
            e.preventDefault();
            alert('Выберите хотя бы один пост');
            return;
        }
    });
</script>
{% endblock %}