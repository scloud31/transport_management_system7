{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Заявка на регулярный рейс</h2>
        <a href="{{ url_for('shift_handover_index') }}" class="btn btn-secondary">Назад</a>
    </div>

    <form method="POST" id="regularForm">
        <div class="row">
            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-header">
                        <h5>Информация о рейсе</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Дата вылета *</label>
                            <input type="date" class="form-control" name="flight_date" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Аэропорт вылета *</label>
                            <select class="form-select" name="departure_airport_id" required>
                                <option value="">Выберите аэропорт</option>
                                <!-- Список аэропортов -->
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Аэропорт прилета *</label>
                            <select class="form-select" name="arrival_airport_id" required>
                                <option value="">Выберите аэропорт</option>
                                <!-- Список аэропортов -->
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Номер рейса</label>
                            <input type="text" class="form-control" name="flight_number">
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-header">
                        <h5>Стоимость и сотрудники</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Предварительная стоимость</label>
                            <input type="text" class="form-control" name="preliminary_cost" placeholder="в рублях">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Выбор сотрудников</label>
                            <select class="form-select" name="employees" id="employeesSelect" multiple>
                                {% for employee in employees %}
                                <option value="{{ employee.id }}">
                                    {{ employee.last_name }} {{ employee.first_name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <button type="button" class="btn btn-outline-primary" onclick="addToRequest()">
                                Добавить в заявку
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-header">
                        <h5>Подписание</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Заявку сформировал *</label>
                            <input type="text" class="form-control" name="formed_by" required>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Список добавленных в заявку -->
        <div class="row mt-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Добавленные в заявку</h5>
                    </div>
                    <div class="card-body">
                        <div id="requestItems">
                            <p class="text-muted">Элементы не добавлены</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-12">
                <button type="submit" class="btn btn-success">Сохранить заявку</button>
                <a href="{{ url_for('shift_handover_index') }}" class="btn btn-secondary">Отменить</a>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
let requestItems = [];

function addToRequest() {
    const flightDate = document.querySelector('input[name="flight_date"]').value;
    const departure = document.querySelector('select[name="departure_airport_id"]').value;
    const arrival = document.querySelector('select[name="arrival_airport_id"]').value;
    const employees = Array.from(document.getElementById('employeesSelect').selectedOptions)
        .map(opt => opt.text);
    
    if (flightDate && departure && arrival && employees.length > 0) {
        const item = {
            flightDate,
            departure,
            arrival,
            employees: [...employees]
        };
        
        requestItems.push(item);
        updateRequestItemsDisplay();
        
        // Очищаем поля для следующего добавления
        document.getElementById('employeesSelect').selectedIndex = -1;
    } else {
        alert('Заполните все обязательные поля для добавления в заявку');
    }
}

function updateRequestItemsDisplay() {
    const container = document.getElementById('requestItems');
    container.innerHTML = '';
    
    if (requestItems.length === 0) {
        container.innerHTML = '<p class="text-muted">Элементы не добавлены</p>';
        return;
    }
    
    requestItems.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'alert alert-info';
        div.innerHTML = `
            <strong>Рейс ${index + 1}:</strong> ${item.flightDate} | ${item.departure} - ${item.arrival}
            <br><strong>Сотрудники:</strong> ${item.employees.join(', ')}
            <button type="button" class="btn-close float-end" onclick="removeRequestItem(${index})"></button>
        `;
        container.appendChild(div);
    });
}

function removeRequestItem(index) {
    requestItems.splice(index, 1);
    updateRequestItemsDisplay();
}

document.getElementById('regularForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (requestItems.length === 0) {
        alert('Добавьте хотя бы один элемент в заявку');
        return;
    }
    
    // Добавляем данные о всех элементах в скрытое поле
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'request_items';
    input.value = JSON.stringify(requestItems);
    this.appendChild(input);
    
    this.submit();
});
</script>
{% endblock %}