{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Заполнить чек-лист</h2>
        <a href="{{ url_for('checklists_list') }}" class="btn btn-secondary">Назад к списку</a>
    </div>

    <form method="POST" action="{{ url_for('save_checklist') }}">
        <div class="card mb-4">
            <div class="card-header">
                <h5>Выбор формы</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Форма чек-листа *</label>
                    <select class="form-select" name="form_id" id="formSelect" required onchange="loadFormStructure()">
                        <option value="">Выберите форму</option>
                        {% for form in forms %}
                        <option value="{{ form.id }}">{{ form.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Заполнил *</label>
                    <input type="text" class="form-control" name="filled_by" required>
                </div>
            </div>
        </div>

        <div id="formContainer">
            <!-- Форма будет загружена здесь динамически -->
            <div class="alert alert-info text-center">
                Выберите форму чек-листа для заполнения
            </div>
        </div>

        <div class="mt-4">
            <button type="submit" class="btn btn-success" id="submitBtn" disabled>Сохранить чек-лист</button>
            <a href="{{ url_for('checklists_list') }}" class="btn btn-secondary">Отменить</a>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
function loadFormStructure() {
    const formId = document.getElementById('formSelect').value;
    const formContainer = document.getElementById('formContainer');
    const submitBtn = document.getElementById('submitBtn');
    
    if (!formId) {
        formContainer.innerHTML = '<div class="alert alert-info text-center">Выберите форму чек-листа для заполнения</div>';
        submitBtn.disabled = true;
        return;
    }
    
    // Загрузка структуры формы через AJAX
    fetch(`/mechanic/checklists/forms/${formId}/structure`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                formContainer.innerHTML = data.html;
                submitBtn.disabled = false;
            }
        })
        .catch(error => {
            formContainer.innerHTML = '<div class="alert alert-danger">Ошибка загрузки формы</div>';
            submitBtn.disabled = true;
        });
}

// Пример структуры формы (в реальной системе будет загружаться с сервера)
const sampleFormStructure = `
    <div class="card">
        <div class="card-header">
            <h5>Проверка транспортного средства</h5>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label">Госномер транспортного средства</label>
                <input type="text" class="form-control" name="field_1" required>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Дата проверки</label>
                <input type="date" class="form-control" name="field_2" required>
            </div>
            
            <div class="mb-3 form-check">
                <input type="checkbox" class="form-check-input" name="field_3" value="1">
                <label class="form-check-label">Тормозная система исправна</label>
            </div>
            
            <div class="mb-3 form-check">
                <input type="checkbox" class="form-check-input" name="field_4" value="1">
                <label class="form-check-label">Осветительные приборы работают</label>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Состояние шин</label>
                <select class="form-select" name="field_5">
                    <option value="отличное">Отличное</option>
                    <option value="удовлетворительное">Удовлетворительное</option>
                    <option value="требует замены">Требует замены</option>
                </select>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Комментарии</label>
                <textarea class="form-control" name="field_6" rows="3"></textarea>
            </div>
        </div>
    </div>
`;
</script>
{% endblock %}