{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Создать тест</h2>
        <a href="{{ url_for('tests_list') }}" class="btn btn-secondary">Назад к списку</a>
    </div>

    <form method="POST" action="{{ url_for('save_test') }}" id="testForm">
        <div class="card mb-4">
            <div class="card-header">
                <h5>Основная информация</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Название теста *</label>
                    <input type="text" class="form-control" name="test_name" required>
                </div>
            </div>
        </div>

        <div id="questionsContainer">
            <!-- Вопросы будут добавляться динамически -->
        </div>

        <div class="mb-3">
            <button type="button" class="btn btn-outline-primary" onclick="addQuestion()">
                + Добавить вопрос
            </button>
        </div>

        <div class="mt-4">
            <button type="submit" class="btn btn-success">Сохранить тест</button>
            <a href="{{ url_for('tests_list') }}" class="btn btn-secondary">Отменить</a>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
let questionCount = 0;

function addQuestion() {
    questionCount++;
    const container = document.getElementById('questionsContainer');
    
    const questionDiv = document.createElement('div');
    questionDiv.className = 'card mb-3 question-item';
    questionDiv.innerHTML = `
        <div class="card-header d-flex justify-content-between align-items-center">
            <h6>Вопрос #${questionCount}</h6>
            <button type="button" class="btn btn-sm btn-danger" onclick="removeQuestion(this)">Удалить</button>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label">Текст вопроса *</label>
                <textarea class="form-control" name="question_${questionCount}_text" rows="3" required></textarea>
            </div>
            
            <div class="answers-container" id="answers_${questionCount}">
                <!-- Ответы будут добавляться динамически -->
            </div>
            
            <div class="mb-3">
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="addAnswer(${questionCount})">
                    + Добавить ответ
                </button>
            </div>
            
            <div class="form-check">
                <input class="form-check-input" type="checkbox" name="question_${questionCount}_multiple" id="multiple_${questionCount}">
                <label class="form-check-label" for="multiple_${questionCount}">
                    Несколько правильных ответов
                </label>
            </div>
        </div>
    `;
    
    container.appendChild(questionDiv);
    
    // Добавляем первые 2 ответа
    addAnswer(questionCount);
    addAnswer(questionCount);
}

function addAnswer(questionId) {
    const container = document.getElementById(`answers_${questionId}`);
    const answerCount = container.children.length + 1;
    
    const answerDiv = document.createElement('div');
    answerDiv.className = 'row mb-2 answer-item';
    answerDiv.innerHTML = `
        <div class="col-md-8">
            <input type="text" class="form-control" name="question_${questionId}_answer_${answerCount}_text" 
                   placeholder="Текст ответа" required>
        </div>
        <div class="col-md-3">
            <div class="form-check mt-2">
                <input class="form-check-input" type="checkbox" name="question_${questionId}_answer_${answerCount}_correct" 
                       id="answer_${questionId}_${answerCount}_correct">
                <label class="form-check-label" for="answer_${questionId}_${answerCount}_correct">
                    Правильный
                </label>
            </div>
        </div>
        <div class="col-md-1">
            <button type="button" class="btn btn-sm btn-outline-danger mt-2" onclick="removeAnswer(this)">×</button>
        </div>
    `;
    
    container.appendChild(answerDiv);
}

function removeQuestion(button) {
    button.closest('.question-item').remove();
    // Пересчитываем номера вопросов
    const questions = document.querySelectorAll('.question-item');
    questions.forEach((question, index) => {
        question.querySelector('h6').textContent = `Вопрос #${index + 1}`;
    });
    questionCount = questions.length;
}

function removeAnswer(button) {
    const answerDiv = button.closest('.answer-item');
    const container = answerDiv.parentElement;
    if (container.children.length > 1) {
        answerDiv.remove();
    } else {
        alert('Должен остаться хотя бы один ответ');
    }
}

// Добавляем первый вопрос при загрузке
document.addEventListener('DOMContentLoaded', function() {
    addQuestion();
});
</script>
{% endblock %}